{"ast":null,"code":"import { __assign, __awaiter, __extends, __generator } from \"tslib\";\nimport * as tf from '@tensorflow/tfjs-core';\nimport { BoundingBox } from '../classes/BoundingBox';\nimport { ObjectDetection } from '../classes/ObjectDetection';\nimport { convLayer } from '../common';\nimport { toNetInput } from '../dom';\nimport { NeuralNetwork } from '../NeuralNetwork';\nimport { sigmoid } from '../ops';\nimport { nonMaxSuppression } from '../ops/nonMaxSuppression';\nimport { normalize } from '../ops/normalize';\nimport { validateConfig } from './config';\nimport { convWithBatchNorm } from './convWithBatchNorm';\nimport { depthwiseSeparableConv } from './depthwiseSeparableConv';\nimport { extractParams } from './extractParams';\nimport { extractParamsFromWeigthMap } from './extractParamsFromWeigthMap';\nimport { leaky } from './leaky';\nimport { TinyYolov2Options } from './TinyYolov2Options';\nvar TinyYolov2Base = /** @class */function (_super) {\n  __extends(TinyYolov2Base, _super);\n  function TinyYolov2Base(config) {\n    var _this = _super.call(this, 'TinyYolov2') || this;\n    validateConfig(config);\n    _this._config = config;\n    return _this;\n  }\n  Object.defineProperty(TinyYolov2Base.prototype, \"config\", {\n    get: function () {\n      return this._config;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(TinyYolov2Base.prototype, \"withClassScores\", {\n    get: function () {\n      return this.config.withClassScores || this.config.classes.length > 1;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(TinyYolov2Base.prototype, \"boxEncodingSize\", {\n    get: function () {\n      return 5 + (this.withClassScores ? this.config.classes.length : 0);\n    },\n    enumerable: true,\n    configurable: true\n  });\n  TinyYolov2Base.prototype.runTinyYolov2 = function (x, params) {\n    var out = convWithBatchNorm(x, params.conv0);\n    out = tf.maxPool(out, [2, 2], [2, 2], 'same');\n    out = convWithBatchNorm(out, params.conv1);\n    out = tf.maxPool(out, [2, 2], [2, 2], 'same');\n    out = convWithBatchNorm(out, params.conv2);\n    out = tf.maxPool(out, [2, 2], [2, 2], 'same');\n    out = convWithBatchNorm(out, params.conv3);\n    out = tf.maxPool(out, [2, 2], [2, 2], 'same');\n    out = convWithBatchNorm(out, params.conv4);\n    out = tf.maxPool(out, [2, 2], [2, 2], 'same');\n    out = convWithBatchNorm(out, params.conv5);\n    out = tf.maxPool(out, [2, 2], [1, 1], 'same');\n    out = convWithBatchNorm(out, params.conv6);\n    out = convWithBatchNorm(out, params.conv7);\n    return convLayer(out, params.conv8, 'valid', false);\n  };\n  TinyYolov2Base.prototype.runMobilenet = function (x, params) {\n    var out = this.config.isFirstLayerConv2d ? leaky(convLayer(x, params.conv0, 'valid', false)) : depthwiseSeparableConv(x, params.conv0);\n    out = tf.maxPool(out, [2, 2], [2, 2], 'same');\n    out = depthwiseSeparableConv(out, params.conv1);\n    out = tf.maxPool(out, [2, 2], [2, 2], 'same');\n    out = depthwiseSeparableConv(out, params.conv2);\n    out = tf.maxPool(out, [2, 2], [2, 2], 'same');\n    out = depthwiseSeparableConv(out, params.conv3);\n    out = tf.maxPool(out, [2, 2], [2, 2], 'same');\n    out = depthwiseSeparableConv(out, params.conv4);\n    out = tf.maxPool(out, [2, 2], [2, 2], 'same');\n    out = depthwiseSeparableConv(out, params.conv5);\n    out = tf.maxPool(out, [2, 2], [1, 1], 'same');\n    out = params.conv6 ? depthwiseSeparableConv(out, params.conv6) : out;\n    out = params.conv7 ? depthwiseSeparableConv(out, params.conv7) : out;\n    return convLayer(out, params.conv8, 'valid', false);\n  };\n  TinyYolov2Base.prototype.forwardInput = function (input, inputSize) {\n    var _this = this;\n    var params = this.params;\n    if (!params) {\n      throw new Error('TinyYolov2 - load model before inference');\n    }\n    return tf.tidy(function () {\n      var batchTensor = input.toBatchTensor(inputSize, false).toFloat();\n      batchTensor = _this.config.meanRgb ? normalize(batchTensor, _this.config.meanRgb) : batchTensor;\n      batchTensor = batchTensor.div(tf.scalar(256));\n      return _this.config.withSeparableConvs ? _this.runMobilenet(batchTensor, params) : _this.runTinyYolov2(batchTensor, params);\n    });\n  };\n  TinyYolov2Base.prototype.forward = function (input, inputSize) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            _a = this.forwardInput;\n            return [4 /*yield*/, toNetInput(input)];\n          case 1:\n            return [4 /*yield*/, _a.apply(this, [_b.sent(), inputSize])];\n          case 2:\n            return [2 /*return*/, _b.sent()];\n        }\n      });\n    });\n  };\n  TinyYolov2Base.prototype.detect = function (input, forwardParams) {\n    if (forwardParams === void 0) {\n      forwardParams = {};\n    }\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, inputSize, scoreThreshold, netInput, out, out0, inputDimensions, results, boxes, scores, classScores, classNames, indices, detections;\n      var _this = this;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            _a = new TinyYolov2Options(forwardParams), inputSize = _a.inputSize, scoreThreshold = _a.scoreThreshold;\n            return [4 /*yield*/, toNetInput(input)];\n          case 1:\n            netInput = _b.sent();\n            return [4 /*yield*/, this.forwardInput(netInput, inputSize)];\n          case 2:\n            out = _b.sent();\n            out0 = tf.tidy(function () {\n              return tf.unstack(out)[0].expandDims();\n            });\n            inputDimensions = {\n              width: netInput.getInputWidth(0),\n              height: netInput.getInputHeight(0)\n            };\n            return [4 /*yield*/, this.extractBoxes(out0, netInput.getReshapedInputDimensions(0), scoreThreshold)];\n          case 3:\n            results = _b.sent();\n            out.dispose();\n            out0.dispose();\n            boxes = results.map(function (res) {\n              return res.box;\n            });\n            scores = results.map(function (res) {\n              return res.score;\n            });\n            classScores = results.map(function (res) {\n              return res.classScore;\n            });\n            classNames = results.map(function (res) {\n              return _this.config.classes[res.label];\n            });\n            indices = nonMaxSuppression(boxes.map(function (box) {\n              return box.rescale(inputSize);\n            }), scores, this.config.iouThreshold, true);\n            detections = indices.map(function (idx) {\n              return new ObjectDetection(scores[idx], classScores[idx], classNames[idx], boxes[idx], inputDimensions);\n            });\n            return [2 /*return*/, detections];\n        }\n      });\n    });\n  };\n  TinyYolov2Base.prototype.getDefaultModelName = function () {\n    return '';\n  };\n  TinyYolov2Base.prototype.extractParamsFromWeigthMap = function (weightMap) {\n    return extractParamsFromWeigthMap(weightMap, this.config);\n  };\n  TinyYolov2Base.prototype.extractParams = function (weights) {\n    var filterSizes = this.config.filterSizes || TinyYolov2Base.DEFAULT_FILTER_SIZES;\n    var numFilters = filterSizes ? filterSizes.length : undefined;\n    if (numFilters !== 7 && numFilters !== 8 && numFilters !== 9) {\n      throw new Error(\"TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found \" + numFilters + \" filterSizes in config\");\n    }\n    return extractParams(weights, this.config, this.boxEncodingSize, filterSizes);\n  };\n  TinyYolov2Base.prototype.extractBoxes = function (outputTensor, inputBlobDimensions, scoreThreshold) {\n    return __awaiter(this, void 0, void 0, function () {\n      var width, height, inputSize, correctionFactorX, correctionFactorY, numCells, numBoxes, _a, boxesTensor, scoresTensor, classScoresTensor, results, scoresData, boxesData, row, col, anchor, score, ctX, ctY, width_1, height_1, x, y, pos, _b, classScore, label, _c;\n      var _this = this;\n      return __generator(this, function (_d) {\n        switch (_d.label) {\n          case 0:\n            width = inputBlobDimensions.width, height = inputBlobDimensions.height;\n            inputSize = Math.max(width, height);\n            correctionFactorX = inputSize / width;\n            correctionFactorY = inputSize / height;\n            numCells = outputTensor.shape[1];\n            numBoxes = this.config.anchors.length;\n            _a = tf.tidy(function () {\n              var reshaped = outputTensor.reshape([numCells, numCells, numBoxes, _this.boxEncodingSize]);\n              var boxes = reshaped.slice([0, 0, 0, 0], [numCells, numCells, numBoxes, 4]);\n              var scores = reshaped.slice([0, 0, 0, 4], [numCells, numCells, numBoxes, 1]);\n              var classScores = _this.withClassScores ? tf.softmax(reshaped.slice([0, 0, 0, 5], [numCells, numCells, numBoxes, _this.config.classes.length]), 3) : tf.scalar(0);\n              return [boxes, scores, classScores];\n            }), boxesTensor = _a[0], scoresTensor = _a[1], classScoresTensor = _a[2];\n            results = [];\n            return [4 /*yield*/, scoresTensor.array()];\n          case 1:\n            scoresData = _d.sent();\n            return [4 /*yield*/, boxesTensor.array()];\n          case 2:\n            boxesData = _d.sent();\n            row = 0;\n            _d.label = 3;\n          case 3:\n            if (!(row < numCells)) return [3 /*break*/, 12];\n            col = 0;\n            _d.label = 4;\n          case 4:\n            if (!(col < numCells)) return [3 /*break*/, 11];\n            anchor = 0;\n            _d.label = 5;\n          case 5:\n            if (!(anchor < numBoxes)) return [3 /*break*/, 10];\n            score = sigmoid(scoresData[row][col][anchor][0]);\n            if (!(!scoreThreshold || score > scoreThreshold)) return [3 /*break*/, 9];\n            ctX = (col + sigmoid(boxesData[row][col][anchor][0])) / numCells * correctionFactorX;\n            ctY = (row + sigmoid(boxesData[row][col][anchor][1])) / numCells * correctionFactorY;\n            width_1 = Math.exp(boxesData[row][col][anchor][2]) * this.config.anchors[anchor].x / numCells * correctionFactorX;\n            height_1 = Math.exp(boxesData[row][col][anchor][3]) * this.config.anchors[anchor].y / numCells * correctionFactorY;\n            x = ctX - width_1 / 2;\n            y = ctY - height_1 / 2;\n            pos = {\n              row: row,\n              col: col,\n              anchor: anchor\n            };\n            if (!this.withClassScores) return [3 /*break*/, 7];\n            return [4 /*yield*/, this.extractPredictedClass(classScoresTensor, pos)];\n          case 6:\n            _c = _d.sent();\n            return [3 /*break*/, 8];\n          case 7:\n            _c = {\n              classScore: 1,\n              label: 0\n            };\n            _d.label = 8;\n          case 8:\n            _b = _c, classScore = _b.classScore, label = _b.label;\n            results.push(__assign({\n              box: new BoundingBox(x, y, x + width_1, y + height_1),\n              score: score,\n              classScore: score * classScore,\n              label: label\n            }, pos));\n            _d.label = 9;\n          case 9:\n            anchor++;\n            return [3 /*break*/, 5];\n          case 10:\n            col++;\n            return [3 /*break*/, 4];\n          case 11:\n            row++;\n            return [3 /*break*/, 3];\n          case 12:\n            boxesTensor.dispose();\n            scoresTensor.dispose();\n            classScoresTensor.dispose();\n            return [2 /*return*/, results];\n        }\n      });\n    });\n  };\n  TinyYolov2Base.prototype.extractPredictedClass = function (classesTensor, pos) {\n    return __awaiter(this, void 0, void 0, function () {\n      var row, col, anchor, classesData;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            row = pos.row, col = pos.col, anchor = pos.anchor;\n            return [4 /*yield*/, classesTensor.array()];\n          case 1:\n            classesData = _a.sent();\n            return [2 /*return*/, Array(this.config.classes.length).fill(0).map(function (_, i) {\n              return classesData[row][col][anchor][i];\n            }).map(function (classScore, label) {\n              return {\n                classScore: classScore,\n                label: label\n              };\n            }).reduce(function (max, curr) {\n              return max.classScore > curr.classScore ? max : curr;\n            })];\n        }\n      });\n    });\n  };\n  TinyYolov2Base.DEFAULT_FILTER_SIZES = [3, 16, 32, 64, 128, 256, 512, 1024, 1024];\n  return TinyYolov2Base;\n}(NeuralNetwork);\nexport { TinyYolov2Base };","map":{"version":3,"mappings":"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","names":["tf","BoundingBox","ObjectDetection","convLayer","toNetInput","NeuralNetwork","sigmoid","nonMaxSuppression","normalize","validateConfig","convWithBatchNorm","depthwiseSeparableConv","extractParams","extractParamsFromWeigthMap","leaky","TinyYolov2Options","__extends","config","_super","_this","_config","Object","TinyYolov2Base","withClassScores","classes","length","x","params","out","conv0","maxPool","conv1","conv2","conv3","conv4","conv5","conv6","conv7","conv8","isFirstLayerConv2d","input","inputSize","Error","tidy","batchTensor","toBatchTensor","toFloat","meanRgb","div","scalar","withSeparableConvs","runMobilenet","runTinyYolov2","_a","forwardInput","_b","forwardParams","scoreThreshold","netInput","out0","unstack","expandDims","inputDimensions","width","getInputWidth","height","getInputHeight","extractBoxes","getReshapedInputDimensions","results","dispose","boxes","map","box","scores","score","classScores","classScore","classNames","res","label","indices","rescale","iouThreshold","detections","idx","weightMap","weights","filterSizes","DEFAULT_FILTER_SIZES","numFilters","undefined","boxEncodingSize","outputTensor","inputBlobDimensions","Math","max","correctionFactorX","correctionFactorY","numCells","shape","numBoxes","anchors","reshaped","reshape","slice","softmax","boxesTensor","scoresTensor","classScoresTensor","array","scoresData","_d","boxesData","row","col","anchor","ctX","ctY","width_1","exp","height_1","y","pos","extractPredictedClass","_c","push","classesTensor","classesData","Array","fill","_","i","reduce","curr"],"sources":["../../../src/tinyYolov2/TinyYolov2Base.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module","externalDependencies":[]}